<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>名城印章榮譽工坊 | Castle Stamp Studio</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 引入 Lucide Icons (圖示庫) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 自定義樣式補充 */
        body {
            background-color: #1c1917; /* stone-900 */
        }
        /* 隱藏滾動條但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // --- Lucide Icon 轉接層 (已修復解構錯誤) ---
        // 將 lucide 全域物件轉換為 React Component
        const LucideIcon = ({ name, size = 24, className, ...props }) => {
            // 安全檢查：確保 lucide 物件存在
            if (typeof lucide === 'undefined' || !lucide.icons) return null;

            const iconData = lucide.icons[name];
            if (!iconData) return null;

            // iconData 是一個數組: ["svg", { attrs }, [children]]
            
            // 遞迴渲染子元素
            const renderChildren = (children) => {
                // 安全檢查：確保 children 是一個陣列
                if (!Array.isArray(children)) return null;

                return children.map((child, index) => {
                    // 安全檢查：確保 child 也是陣列 (防止解構非陣列物件時報錯)
                    if (!Array.isArray(child)) return null;

                    const tag = child[0];
                    const attrs = child[1] || {};
                    const subChildren = child[2];

                    return React.createElement(
                        tag,
                        { key: index, ...attrs },
                        // 安全檢查：只有當 subChildren 是有效陣列時才遞迴
                        (Array.isArray(subChildren) && subChildren.length > 0) ? renderChildren(subChildren) : null
                    );
                });
            };

            return React.createElement(
                "svg",
                {
                    ...iconData[1], // SVG 屬性
                    width: size,
                    height: size,
                    className: className,
                    ...props
                },
                // 安全檢查：確保傳入的是陣列
                renderChildren(iconData[2] || []) 
            );
        };

        // 定義原本程式碼中用到的圖示
        const Upload = (props) => <LucideIcon name="Upload" {...props} />;
        const Sliders = (props) => <LucideIcon name="Sliders" {...props} />;
        const Download = (props) => <LucideIcon name="Download" {...props} />;
        const CheckCircle = (props) => <LucideIcon name="CheckCircle" {...props} />;
        const Shield = (props) => <LucideIcon name="Shield" {...props} />;
        const Eraser = (props) => <LucideIcon name="Eraser" {...props} />;
        const Palette = (props) => <LucideIcon name="Palette" {...props} />;
        const Sparkles = (props) => <LucideIcon name="Sparkles" {...props} />;
        const Maximize2 = (props) => <LucideIcon name="Maximize2" {...props} />;
        const Scaling = (props) => <LucideIcon name="Scaling" {...props} />;


        // --- Badge Components (SVG Definitions) ---
        // 保持原樣，這是純粹的 SVG Component

        const BadgeA_WaxSeal = () => (
            <svg viewBox="0 0 100 100" className="drop-shadow-lg w-full h-full">
                <defs>
                <linearGradient id="bronzeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stopColor="#D97706" />
                    <stop offset="50%" stopColor="#B45309" />
                    <stop offset="100%" stopColor="#78350F" />
                </linearGradient>
                <filter id="insetShadow">
                    <feOffset dx="0" dy="2" />
                    <feGaussianBlur stdDeviation="2" result="offset-blur" />
                    <feComposite operator="out" in="SourceGraphic" in2="offset-blur" result="inverse" />
                    <feFlood floodColor="black" floodOpacity="0.5" result="color" />
                    <feComposite operator="in" in="color" in2="inverse" result="shadow" />
                    <feComposite operator="over" in="shadow" in2="SourceGraphic" />
                </filter>
                </defs>
                <path 
                d="M50 5 C55 5, 58 8, 62 6 C66 4, 70 8, 73 11 C76 14, 80 15, 83 19 C86 23, 90 25, 91 30 C92 35, 95 38, 94 43 C93 48, 95 52, 93 57 C91 62, 92 67, 89 71 C86 75, 85 80, 81 83 C77 86, 74 89, 69 91 C64 93, 60 92, 55 94 C50 96, 45 94, 40 93 C35 92, 30 93, 26 90 C22 87, 18 85, 15 81 C12 77, 8 74, 7 69 C6 64, 8 59, 7 54 C6 49, 4 45, 6 40 C8 35, 9 30, 12 26 C15 22, 19 20, 23 16 C27 12, 32 10, 37 8 C42 6, 45 5, 50 5 Z" 
                fill="url(#bronzeGradient)" 
                />
                <circle cx="50" cy="50" r="35" fill="none" stroke="#78350F" strokeWidth="2" opacity="0.6" />
                <circle cx="50" cy="50" r="32" fill="#92400E" filter="url(#insetShadow)" />
                <text x="50" y="58" textAnchor="middle" fill="#FEF3C7" fontSize="24" fontFamily="serif" fontWeight="bold" style={{textShadow: '1px 1px 2px rgba(0,0,0,0.5)'}}>登城</text>
                <text x="50" y="32" textAnchor="middle" fill="#FEF3C7" fontSize="8" fontFamily="sans-serif" letterSpacing="2">VISITED</text>
            </svg>
        );

        const BadgeB_Sunburst = () => (
            <svg viewBox="0 0 100 100" className="drop-shadow-lg w-full h-full">
                <defs>
                <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stopColor="#FDE047" />
                    <stop offset="40%" stopColor="#EAB308" />
                    <stop offset="100%" stopColor="#A16207" />
                </linearGradient>
                </defs>
                <g transform="translate(50,50)">
                {[...Array(16)].map((_, i) => (
                    <path 
                    key={i}
                    d="M0,-48 L10,-15 L0,0 L-10,-15 Z" 
                    fill="url(#goldGradient)" 
                    transform={`rotate(${i * 22.5})`} 
                    />
                ))}
                </g>
                <circle cx="50" cy="50" r="28" fill="#FACC15" stroke="#CA8A04" strokeWidth="2" />
                <circle cx="50" cy="50" r="24" fill="#B45309" />
                <text x="50" y="59" textAnchor="middle" fill="#FFF" fontSize="24" fontFamily="serif" fontWeight="bold">制霸</text>
                <path d="M 30 75 Q 50 85 70 75" fill="none" stroke="#CA8A04" strokeWidth="3" />
            </svg>
        );

        const BadgeC_Rosette = () => (
            <svg viewBox="0 0 100 100" className="drop-shadow-lg w-full h-full">
                <defs>
                <linearGradient id="silverGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stopColor="#F3F4F6" />
                    <stop offset="50%" stopColor="#9CA3AF" />
                    <stop offset="100%" stopColor="#4B5563" />
                </linearGradient>
                </defs>
                <g transform="translate(50,50)">
                {[...Array(12)].map((_, i) => (
                    <circle 
                    key={i}
                    cx="0" cy="-38" r="10" 
                    fill="#DC2626" 
                    stroke="#991B1B" 
                    strokeWidth="1"
                    transform={`rotate(${i * 30})`} 
                    />
                ))}
                </g>
                <circle cx="50" cy="50" r="35" fill="#FCA5A5" stroke="#991B1B" strokeWidth="1" />
                <circle cx="50" cy="50" r="25" fill="url(#silverGradient)" stroke="#374151" strokeWidth="2" />
                <text x="50" y="55" textAnchor="middle" fill="#1F2937" fontSize="14" fontFamily="serif" fontWeight="bold">百名城</text>
                <text x="50" y="35" textAnchor="middle" fill="#374151" fontSize="6" fontFamily="sans-serif">OFFICIAL</text>
                <text x="50" y="70" textAnchor="middle" fill="#374151" fontSize="6" fontFamily="sans-serif">COLLECTION</text>
            </svg>
        );


        // --- Main Application ---
        // 這是原本的 CastleStampStudio 元件，僅移除了 TypeScript 類型標註

        const CastleStampStudio = () => {
            // Image States
            const [originalImage, setOriginalImage] = useState(null);
            const [processedStampImage, setProcessedStampImage] = useState(null); // The backed stamp
            const [outputResolution, setOutputResolution] = useState('-');
            
            // Processing Parameters
            const [threshold, setThreshold] = useState(20);
            const [dilation, setDilation] = useState(2);
            const [backingColor, setBackingColor] = useState('white');
            const [isProcessing, setIsProcessing] = useState(false);
            
            // Badge States
            const [selectedBadge, setSelectedBadge] = useState(null);
            const [badgeScale, setBadgeScale] = useState(30); // Percentage 10-100

            const canvasRef = useRef(null);
            const finalCanvasRef = useRef(null); // For compositing the download

            // 1. Handle Upload
            const handleImageUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    setOriginalImage(event.target?.result);
                    setSelectedBadge(null); // Reset badge
                };
                reader.readAsDataURL(file);
                }
            };

            // 2. Core Algorithm (From Stage 1 + Color Upgrade)
            const processImage = useCallback(() => {
                if (!originalImage || !canvasRef.current) return;

                setIsProcessing(true);
                const img = new Image();
                img.src = originalImage;
                
                img.onload = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                canvas.width = img.width;
                canvas.height = img.height;

                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const width = canvas.width;
                const height = canvas.height;
                const grid = new Int8Array(width * height);
                
                // Threshold
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i + 3] > threshold) grid[i / 4] = 1;
                    else grid[i / 4] = 0;
                }

                // Dilation
                let wallGrid = new Int8Array(grid);
                if (dilation > 0) {
                    const tempGrid = new Int8Array(width * height);
                    const radius = dilation;
                    for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        if (wallGrid[y * width + x] === 1) {
                        for (let dy = -radius; dy <= radius; dy++) {
                            for (let dx = -radius; dx <= radius; dx++) {
                            const ny = y + dy;
                            const nx = x + dx;
                            if (ny >= 0 && ny < height && nx >= 0 && nx < width) {
                                tempGrid[ny * width + nx] = 1;
                            }
                            }
                        }
                        }
                    }
                    }
                    wallGrid = tempGrid;
                }

                // Flood Fill
                const stack = [];
                for (let x = 0; x < width; x++) {
                    if (wallGrid[x] === 0) stack.push([x, 0]);
                    if (wallGrid[(height - 1) * width + x] === 0) stack.push([x, height - 1]);
                }
                for (let y = 0; y < height; y++) {
                    if (wallGrid[y * width] === 0) stack.push([0, y]);
                    if (wallGrid[y * width + (width - 1)] === 0) stack.push([width - 1, y]);
                }

                const visited = new Int8Array(width * height);
                while (stack.length > 0) {
                    const [x, y] = stack.pop();
                    const idx = y * width + x;
                    if (visited[idx] === 1 || wallGrid[idx] === 1) continue;
                    visited[idx] = 1;
                    if (x > 0) stack.push([x - 1, y]);
                    if (x < width - 1) stack.push([x + 1, y]);
                    if (y > 0) stack.push([x, y - 1]);
                    if (y < height - 1) stack.push([x, y + 1]);
                }

                // Render Backing with Style
                const finalImageData = ctx.createImageData(width, height);
                const finalData = finalImageData.data;
                
                for (let i = 0; i < width * height; i++) {
                    if (visited[i] === 0) {
                    // It's inside the shape
                    if (backingColor === 'white') {
                        finalData[i * 4] = 255;
                        finalData[i * 4 + 1] = 255;
                        finalData[i * 4 + 2] = 255;
                        finalData[i * 4 + 3] = 255;
                    } else {
                        // Gold Gradient Logic
                        const x = i % width;
                        const y = Math.floor(i / width);
                        const sheen = Math.sin((x + y) / 40); 
                        const factor = (sheen + 1) / 2;

                        const r = 235 + (20 * factor);
                        const g = 215 + (37 * factor);
                        const b = 150 + (85 * factor);

                        finalData[i * 4] = r;
                        finalData[i * 4 + 1] = g;
                        finalData[i * 4 + 2] = b;
                        finalData[i * 4 + 3] = 255;
                    }
                    } else {
                    finalData[i * 4 + 3] = 0;
                    }
                }
                
                ctx.putImageData(finalImageData, 0, 0);
                ctx.drawImage(img, 0, 0); // Layer Original on top

                setProcessedStampImage(canvas.toDataURL());
                setIsProcessing(false);
                };
            }, [originalImage, threshold, dilation, backingColor]);

            // Trigger processing
            useEffect(() => {
                if (originalImage) {
                const timer = setTimeout(processImage, 100);
                return () => clearTimeout(timer);
                }
            }, [originalImage, threshold, dilation, backingColor, processImage]);

            // 3. Download Logic (High Resolution Output)
            const handleDownload = () => {
                if (!processedStampImage || !finalCanvasRef.current) return;

                const canvas = finalCanvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';

                const stampImg = new Image();
                stampImg.src = processedStampImage;

                stampImg.onload = () => {
                const MIN_DIMENSION = 1024;
                const currentMin = Math.min(stampImg.width, stampImg.height);
                
                let scale = 1;
                if (currentMin < MIN_DIMENSION) {
                    scale = MIN_DIMENSION / currentMin;
                }
                
                const stampWidth = Math.round(stampImg.width * scale);
                const stampHeight = Math.round(stampImg.height * scale);

                // Prepare Badge Size (Dynamic)
                const scaleFactor = badgeScale / 100;
                const baseSize = Math.min(stampWidth, stampHeight);
                const badgeSize = baseSize * scaleFactor;

                canvas.width = stampWidth;
                canvas.height = stampHeight;
                setOutputResolution(`${stampWidth} x ${stampHeight}`);

                // Draw Stamp
                ctx.drawImage(stampImg, 0, 0, stampWidth, stampHeight);

                if (selectedBadge) {
                    // Draw Badge - Aligned Top Right Flush (Inside)
                    const badgeX = stampWidth - badgeSize;
                    const badgeY = 0;
                    
                    const badgeSvgString = getBadgeSvgString(selectedBadge);
                    const badgeImg = new Image();
                    const svgBlob = new Blob([badgeSvgString], {type: 'image/svg+xml;charset=utf-8'});
                    const url = URL.createObjectURL(svgBlob);
                    
                    badgeImg.onload = () => {
                    ctx.drawImage(badgeImg, badgeX, badgeY, badgeSize, badgeSize);
                    URL.revokeObjectURL(url);
                    triggerDownload(canvas.toDataURL());
                    };
                    badgeImg.src = url;

                } else {
                    triggerDownload(canvas.toDataURL());
                }
                };
            };
            
            const triggerDownload = (dataUrl) => {
                const link = document.createElement('a');
                link.download = `castle_stamp_${selectedBadge || 'processed'}_${backingColor}_highres.png`;
                link.href = dataUrl;
                link.click();
            };

            const getBadgeSvgString = (type) => {
                const commonHeader = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="1024" height="1024">';
                const footer = '</svg>';
                let content = '';
                
                if (type === 'A') {
                content = `
                    <defs>
                    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#D97706"/><stop offset="0.5" stop-color="#B45309"/><stop offset="1" stop-color="#78350F"/></linearGradient>
                    <filter id="s"><feOffset dx="0" dy="2"/><feGaussianBlur stdDeviation="2"/><feComposite operator="out" in="SourceGraphic" result="i"/><feFlood flood-color="black" flood-opacity="0.5"/><feComposite operator="in" in2="i" result="sh"/><feComposite operator="over" in="sh" in2="SourceGraphic"/></filter>
                    </defs>
                    <path d="M50 5 C55 5, 58 8, 62 6 C66 4, 70 8, 73 11 C76 14, 80 15, 83 19 C86 23, 90 25, 91 30 C92 35, 95 38, 94 43 C93 48, 95 52, 93 57 C91 62, 92 67, 89 71 C86 75, 85 80, 81 83 C77 86, 74 89, 69 91 C64 93, 60 92, 55 94 C50 96, 45 94, 40 93 C35 92, 30 93, 26 90 C22 87, 18 85, 15 81 C12 77, 8 74, 7 69 C6 64, 8 59, 7 54 C6 49, 4 45, 6 40 C8 35, 9 30, 12 26 C15 22, 19 20, 23 16 C27 12, 32 10, 37 8 C42 6, 45 5, 50 5 Z" fill="url(#g)"/>
                    <circle cx="50" cy="50" r="35" fill="none" stroke="#78350F" stroke-width="2" opacity="0.6"/>
                    <circle cx="50" cy="50" r="32" fill="#92400E" filter="url(#s)"/>
                    <text x="50" y="58" text-anchor="middle" fill="#FEF3C7" font-size="24" font-family="serif" font-weight="bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5)">登城</text>
                    <text x="50" y="32" text-anchor="middle" fill="#FEF3C7" font-size="8" font-family="sans-serif" letterSpacing="2">VISITED</text>
                `;
                } else if (type === 'B') {
                content = `
                    <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#FDE047"/><stop offset="0.4" stop-color="#EAB308"/><stop offset="1" stop-color="#A16207"/></linearGradient></defs>
                    <g transform="translate(50,50)">${[...Array(16)].map((_,i)=>`<path d="M0,-48 L10,-15 L0,0 L-10,-15 Z" fill="url(#g)" transform="rotate(${i*22.5})"/>`).join('')}</g>
                    <circle cx="50" cy="50" r="28" fill="#FACC15" stroke="#CA8A04" stroke-width="2"/>
                    <circle cx="50" cy="50" r="24" fill="#B45309"/>
                    <text x="50" y="59" text-anchor="middle" fill="#FFF" font-size="24" font-family="serif" font-weight="bold">制霸</text>
                    <path d="M 30 75 Q 50 85 70 75" fill="none" stroke="#CA8A04" stroke-width="3"/>
                `;
                } else if (type === 'C') {
                content = `
                    <defs><linearGradient id="s" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#F3F4F6"/><stop offset="0.5" stop-color="#9CA3AF"/><stop offset="1" stop-color="#4B5563"/></linearGradient></defs>
                    <g transform="translate(50,50)">${[...Array(12)].map((_,i)=>`<circle cx="0" cy="-38" r="10" fill="#DC2626" stroke="#991B1B" stroke-width="1" transform="rotate(${i*30})"/>`).join('')}</g>
                    <circle cx="50" cy="50" r="35" fill="#FCA5A5" stroke="#991B1B" stroke-width="1"/>
                    <circle cx="50" cy="50" r="25" fill="url(#s)" stroke="#374151" stroke-width="2"/>
                    <text x="50" y="55" text-anchor="middle" fill="#1F2937" font-size="14" font-family="serif" font-weight="bold">百名城</text>
                    <text x="50" y="35" text-anchor="middle" fill="#374151" font-size="6" font-family="sans-serif">OFFICIAL</text>
                `;
                }
                return commonHeader + content + footer;
            };

            return (
                <div className="min-h-screen bg-stone-900 text-stone-100 p-4 md:p-8 font-sans selection:bg-amber-500 selection:text-white">
                <div className="max-w-6xl mx-auto space-y-8">
                    
                    {/* Header */}
                    <div className="border-b border-stone-700 pb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 className="text-4xl font-bold bg-gradient-to-r from-amber-200 via-yellow-400 to-amber-600 bg-clip-text text-transparent flex items-center gap-3">
                        <Shield className="text-amber-500" /> 名城印章榮譽工坊
                        </h1>
                        <p className="text-stone-400 mt-2 text-lg">
                        自動襯底 x 榮譽徽章合成系統
                        </p>
                    </div>
                    <div className="bg-amber-900/30 px-4 py-2 rounded-full border border-amber-500/30 text-sm text-amber-400 flex items-center gap-2">
                        <CheckCircle size={16} />
                        <span>第二階段：功能完整解鎖</span>
                    </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left Column: Controls (4 cols) */}
                    <div className="lg:col-span-4 space-y-6">
                        
                        {/* 1. Upload */}
                        <div className="bg-stone-800 rounded-2xl p-6 border border-stone-700 shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Upload size={100} /></div>
                        <h3 className="font-bold text-xl mb-4 text-white flex items-center gap-2">
                            <span className="bg-stone-700 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                            上傳印章
                        </h3>
                        <div className="relative group cursor-pointer">
                            <input 
                            type="file" 
                            accept="image/*" 
                            onChange={handleImageUpload}
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                            />
                            <div className="border-2 border-dashed border-stone-600 rounded-xl p-8 flex flex-col items-center justify-center bg-stone-800/50 group-hover:border-amber-500 group-hover:bg-stone-700 transition-all">
                            <p className="text-stone-400 font-medium group-hover:text-amber-400">點擊上傳名城印章</p>
                            <p className="text-xs text-stone-500 mt-2">支援高解析度輸出 (1024px+)</p>
                            </div>
                        </div>

                        {/* 1.5 Backing Color Selector */}
                        {originalImage && (
                            <div className="mt-6 border-t border-stone-700 pt-4">
                            <h4 className="text-sm font-bold text-stone-300 mb-3 flex items-center gap-2">
                                <Palette size={16} /> 御用底紙設定
                            </h4>
                            <div className="grid grid-cols-2 gap-3">
                                <button 
                                onClick={() => setBackingColor('white')}
                                className={`flex items-center justify-center gap-2 p-3 rounded-xl border-2 transition-all ${backingColor === 'white' ? 'border-amber-500 bg-stone-700 text-white' : 'border-stone-600 text-stone-400 hover:bg-stone-700/50'}`}
                                >
                                <div className="w-4 h-4 rounded-full bg-white border border-stone-300"></div>
                                <span className="text-sm font-medium">純淨白紙</span>
                                </button>
                                <button 
                                onClick={() => setBackingColor('gold')}
                                className={`flex items-center justify-center gap-2 p-3 rounded-xl border-2 transition-all ${backingColor === 'gold' ? 'border-amber-500 bg-amber-900/30 text-amber-100' : 'border-stone-600 text-stone-400 hover:bg-stone-700/50'}`}
                                >
                                <div className="w-4 h-4 rounded-full bg-gradient-to-tr from-yellow-600 to-yellow-200 border border-yellow-600"></div>
                                <span className="text-sm font-medium">流光金箔</span>
                                </button>
                            </div>
                            </div>
                        )}
                        </div>

                        {/* 2. Badge Selection */}
                        <div className={`bg-stone-800 rounded-2xl p-6 border border-stone-700 shadow-xl transition-all ${!processedStampImage ? 'opacity-50 pointer-events-none grayscale' : 'opacity-100'}`}>
                        <h3 className="font-bold text-xl mb-4 text-white flex items-center gap-2">
                            <span className="bg-stone-700 w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                            選擇榮譽徽章
                        </h3>
                        
                        <div className="grid grid-cols-3 gap-3">
                            {/* None Option */}
                            <button 
                            onClick={() => setSelectedBadge(null)}
                            className={`p-2 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${selectedBadge === null ? 'border-amber-500 bg-amber-900/20' : 'border-stone-600 hover:bg-stone-700'}`}
                            >
                            <div className="w-12 h-12 rounded-full bg-stone-700 flex items-center justify-center text-stone-400">
                                <Eraser size={20} />
                            </div>
                            <span className="text-xs font-medium">無</span>
                            </button>

                            {/* Badge A */}
                            <button 
                            onClick={() => setSelectedBadge('A')}
                            className={`p-2 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${selectedBadge === 'A' ? 'border-amber-500 bg-amber-900/20' : 'border-stone-600 hover:bg-stone-700'}`}
                            >
                            <div className="w-12 h-12 relative">
                                <BadgeA_WaxSeal />
                            </div>
                            <span className="text-xs font-medium">經典火漆</span>
                            </button>

                            {/* Badge B */}
                            <button 
                            onClick={() => setSelectedBadge('B')}
                            className={`p-2 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${selectedBadge === 'B' ? 'border-amber-500 bg-amber-900/20' : 'border-stone-600 hover:bg-stone-700'}`}
                            >
                            <div className="w-12 h-12 relative">
                                <BadgeB_Sunburst />
                            </div>
                            <span className="text-xs font-medium">榮耀星芒</span>
                            </button>

                            {/* Badge C */}
                            <button 
                            onClick={() => setSelectedBadge('C')}
                            className={`p-2 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${selectedBadge === 'C' ? 'border-amber-500 bg-amber-900/20' : 'border-stone-600 hover:bg-stone-700'}`}
                            >
                            <div className="w-12 h-12 relative">
                                <BadgeC_Rosette />
                            </div>
                            <span className="text-xs font-medium">皇家緞帶</span>
                            </button>
                        </div>
                        </div>

                        {/* 3. Advanced Settings (Collapsible feel) */}
                        <div className={`bg-stone-800 rounded-2xl p-6 border border-stone-700 shadow-xl ${!processedStampImage ? 'hidden' : 'block'}`}>
                        <h3 className="font-bold text-sm mb-4 text-stone-400 uppercase tracking-wider flex items-center gap-2">
                            <Sliders size={16} /> 參數微調
                        </h3>
                        <div className="space-y-4">
                            
                            {/* New Badge Size Slider */}
                            {selectedBadge && (
                            <div className="pb-4 border-b border-stone-700">
                                <div className="flex justify-between text-xs mb-1">
                                <span className="flex items-center gap-1 text-amber-400 font-bold"><Scaling size={12}/> 徽章尺寸</span>
                                <span className="text-amber-400 font-mono">{badgeScale}%</span>
                                </div>
                                <input 
                                type="range" 
                                min="10" 
                                max="80" 
                                step="5"
                                value={badgeScale} 
                                onChange={(e) => setBadgeScale(Number(e.target.value))} 
                                className="w-full accent-amber-500 h-2 bg-stone-600 rounded-lg appearance-none cursor-pointer" 
                                />
                            </div>
                            )}

                            <div>
                            <div className="flex justify-between text-xs mb-1">
                                <span>邊框修補 (Dilation)</span>
                                <span className="text-stone-400">{dilation}px</span>
                            </div>
                            <input type="range" min="0" max="10" value={dilation} onChange={(e) => setDilation(Number(e.target.value))} className="w-full accent-amber-500 h-1 bg-stone-600 rounded-lg appearance-none cursor-pointer" />
                            </div>
                            <div>
                            <div className="flex justify-between text-xs mb-1">
                                <span>墨色閾值 (Threshold)</span>
                                <span className="text-stone-400">{threshold}</span>
                            </div>
                            <input type="range" min="1" max="100" value={threshold} onChange={(e) => setThreshold(Number(e.target.value))} className="w-full accent-amber-500 h-1 bg-stone-600 rounded-lg appearance-none cursor-pointer" />
                            </div>
                        </div>
                        </div>

                        {/* Download Button */}
                        {processedStampImage && (
                        <button 
                            onClick={handleDownload}
                            className="w-full group bg-gradient-to-r from-amber-600 to-orange-700 hover:from-amber-500 hover:to-orange-600 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg shadow-orange-900/30 flex items-center justify-center gap-3 transform hover:scale-105 active:scale-95"
                        >
                            <div className="flex flex-col items-center">
                            <div className="flex items-center gap-2">
                                <Download size={24} />
                                <span>下載高清成果 (1024px+)</span>
                            </div>
                            </div>
                        </button>
                        )}

                    </div>

                    {/* Right Column: Preview Area (8 cols) */}
                    <div className="lg:col-span-8">
                        <div className="bg-stone-800 rounded-2xl border border-stone-700 h-[600px] flex flex-col relative overflow-hidden shadow-2xl">
                        
                        {/* Toolbar / Status */}
                        <div className="bg-stone-900/80 backdrop-blur-md p-4 border-b border-stone-700 flex justify-between items-center z-20">
                            <div className="flex items-center gap-2">
                            <span className="w-3 h-3 rounded-full bg-red-500"></span>
                            <span className="w-3 h-3 rounded-full bg-yellow-500"></span>
                            <span className="w-3 h-3 rounded-full bg-green-500"></span>
                            </div>
                            <div className="flex items-center gap-3 text-xs font-mono text-stone-500">
                            {backingColor === 'gold' && <span className="flex items-center gap-1 text-amber-400"><Sparkles size={12}/> PREMIUM GOLD</span>}
                            <span>{isProcessing ? 'PROCESSING...' : processedStampImage ? `READY` : 'WAITING_FOR_INPUT'}</span>
                            </div>
                        </div>

                        {/* Canvas Area */}
                        <div className="flex-1 relative flex items-center justify-center p-8 bg-stone-900 overflow-visible group">
                            {/* Background Pattern */}
                            <div className="absolute inset-0 opacity-10" style={{
                                backgroundImage: 'radial-gradient(#44403c 1px, transparent 1px)',
                                backgroundSize: '20px 20px'
                            }}></div>

                            {/* The Stage */}
                            {processedStampImage ? (
                            <div className="relative w-full h-full flex items-center justify-center">
                                
                                {/* Container for the image + badge */}
                                {/* Updated to allow badge to just sit flush in the corner, preview matches final output */}
                                <div className="relative inline-block transition-transform duration-300" style={{ maxWidth: '100%', maxHeight: '100%' }}>
                                
                                {/* The Stamp (Backed) */}
                                <img 
                                    src={processedStampImage} 
                                    alt="Final Stamp" 
                                    className="max-w-full max-h-[500px] object-contain drop-shadow-2xl"
                                    style={{ filter: 'drop-shadow(0 10px 15px rgba(0,0,0,0.5))' }}
                                />

                                {/* The Badge Overlay */}
                                {selectedBadge && (
                                    <div 
                                    className="absolute top-0 right-0 animate-in fade-in zoom-in duration-300 z-10"
                                    style={{
                                        width: `${badgeScale}%`,
                                        height: `${badgeScale}%`
                                    }}
                                    >
                                    {selectedBadge === 'A' && <BadgeA_WaxSeal />}
                                    {selectedBadge === 'B' && <BadgeB_Sunburst />}
                                    {selectedBadge === 'C' && <BadgeC_Rosette />}
                                    </div>
                                )}
                                </div>

                            </div>
                            ) : (
                            <div className="text-stone-600 flex flex-col items-center animate-pulse">
                                <Shield size={64} strokeWidth={1} />
                                <p className="mt-4 text-xl font-light">請上傳您的印章以開始製作</p>
                            </div>
                            )}
                        </div>
                        </div>
                    </div>

                    </div>

                    {/* Hidden Canvas for Processing */}
                    <canvas ref={canvasRef} className="hidden" />
                    <canvas ref={finalCanvasRef} className="hidden" />

                </div>
                </div>
            );
        };

        // 渲染 React 應用
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CastleStampStudio />);
    </script>
</body>
</html>